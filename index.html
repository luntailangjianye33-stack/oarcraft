<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0A0E17">
<title>OARCRAFT v0.9</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0A0E17;color:#E2E8F0;min-height:100vh;min-height:100dvh;overscroll-behavior:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#1E293B;border-radius:3px}
button{font-family:inherit;cursor:pointer}input,select,textarea{font-family:inherit;font-size:16px}

/* LOGIN */
#login{display:flex;align-items:center;justify-content:center;min-height:100vh;min-height:100dvh;padding:20px}
.lb{background:#111827;border:1px solid #1E293B;border-radius:14px;padding:32px;width:90%;max-width:380px;text-align:center}
.lb h1{font-size:22px;font-weight:800;letter-spacing:2px;margin-bottom:3px}.lb h1 b{color:#00E5A0}
.lb .sub{font-size:9px;color:#64748B;letter-spacing:3px;margin-bottom:20px}
.lb input{width:100%;background:#0A0E17;border:1px solid #1E293B;border-radius:8px;padding:12px;color:#E2E8F0;font-size:16px;text-align:center;letter-spacing:4px;font-weight:700;outline:none;margin-bottom:12px}
.lb input:focus{border-color:#00E5A0}
.lb input::placeholder{letter-spacing:1px;font-weight:400;font-size:12px}
.lb .or{color:#475569;font-size:10px;margin:12px 0}
#ls{margin-top:10px;font-size:10px;min-height:18px}

/* APP */
#app{display:none}
header{background:linear-gradient(180deg,#111827,#0A0E17);border-bottom:1px solid #1E293B;padding:0 20px;position:sticky;top:0;z-index:100}
.hdr{display:flex;align-items:center;justify-content:space-between;height:48px;max-width:1200px;margin:0 auto}
.logo{display:flex;align-items:center;gap:7px}
.logo-i{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#00E5A0,#0EA5E9);display:flex;align-items:center;justify-content:center;font-size:12px}
.logo-t{font-size:14px;font-weight:800;letter-spacing:2px}.logo-t b{color:#00E5A0}
nav.desktop-nav{display:flex;gap:1px;height:48px;overflow-x:auto}
nav.desktop-nav button{background:none;border:none;padding:0 9px;height:100%;display:flex;align-items:center;gap:3px;font-size:10px;color:#64748B;transition:.2s;border-bottom:2px solid transparent;white-space:nowrap}
nav.desktop-nav button:hover{color:#E2E8F0}nav.desktop-nav button.on{color:#00E5A0;font-weight:700;border-bottom-color:#00E5A0}
.hi{display:flex;align-items:center;gap:6px}
.sb{padding:2px 8px;border-radius:8px;font-size:8px;font-weight:600}
.sb-on{background:#00E5A018;color:#00E5A0;border:1px solid #00E5A033}
.sb-off{background:#FF475718;color:#FF4757;border:1px solid #FF475733}

/* Bottom Tab Bar (Mobile) */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:100;background:#111827;border-top:1px solid #1E293B;padding:0 0 env(safe-area-inset-bottom,0);height:calc(56px + env(safe-area-inset-bottom,0))}
.bottom-nav-inner{display:flex;justify-content:space-around;align-items:stretch;height:56px;max-width:600px;margin:0 auto}
.bottom-nav button{background:none;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;flex:1;color:#64748B;font-size:9px;font-weight:500;transition:color .2s;padding:4px 0;min-width:0;position:relative}
.bottom-nav button .bnav-ic{font-size:18px;line-height:1;transition:transform .2s}
.bottom-nav button .bnav-lb{font-size:9px;line-height:1;white-space:nowrap}
.bottom-nav button.on{color:#00E5A0;font-weight:700}
.bottom-nav button.on .bnav-ic{transform:scale(1.15)}
.bottom-nav button.on::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:24px;height:2px;background:#00E5A0;border-radius:0 0 2px 2px}

main{max-width:1200px;margin:0 auto;padding:12px 16px 40px}
.tab{display:none}.tab.on{display:block;animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes glow{0%{box-shadow:0 0 4px #00E5A0}50%{box-shadow:0 0 16px #00E5A0}100%{box-shadow:0 0 4px #00E5A0}}
@keyframes streak{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:none}}
.pop{animation:pop .3s ease}.glow{animation:glow 1.5s ease infinite}

.cd{background:#111827;border-radius:10px;border:1px solid #1E293B;padding:14px;margin-bottom:10px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
.mt{text-align:center}.mt-l{font-size:8px;color:#64748B;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.mt-v{font-size:18px;font-weight:800;font-family:monospace;line-height:1}.mt-u{font-size:9px;font-weight:400;color:#64748B}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:4px}
.sh-l{display:flex;align-items:center;gap:4px}.sh em{font-style:normal;font-size:13px}.sh h2{font-size:12px;font-weight:700}
.sh-s{font-size:9px;color:#64748B;margin:-4px 0 10px 0}
.btn{display:inline-flex;align-items:center;gap:3px;padding:5px 10px;border-radius:6px;font-size:10px;font-weight:600;border:none;transition:.2s}
.btn-p{background:#00E5A0;color:#0A0E17}.btn-p:hover{background:#00cc8e}
.btn-s{background:transparent;color:#64748B;border:1px solid #1E293B}.btn-s:hover{border-color:#00E5A0;color:#00E5A0}
.btn-d{background:transparent;color:#FF4757;border:1px solid #FF475733}
.btn-sm{padding:3px 7px;font-size:8px}
.btns{display:flex;gap:4px;flex-wrap:wrap}
table{width:100%;border-collapse:separate;border-spacing:0 2px}
th{text-align:left;padding:5px 6px;font-size:8px;font-weight:600;color:#64748B;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #1E293B}
td{padding:5px 6px;font-size:10px}tr:hover td{background:rgba(0,229,160,.02)}.mono{font-family:monospace}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;animation:fi .2s ease}
.modal{background:#111827;border:1px solid #1E293B;border-radius:12px;padding:18px;width:92%;max-width:500px;max-height:88vh;overflow-y:auto}
.modal h3{font-size:13px;font-weight:700;margin-bottom:10px}
.fg{margin-bottom:8px}.fg label{display:block;font-size:9px;color:#64748B;margin-bottom:2px;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select,.fg textarea{width:100%;background:#0A0E17;border:1px solid #1E293B;border-radius:6px;padding:6px 8px;color:#E2E8F0;font-size:16px;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:#00E5A0}
.fg textarea{resize:vertical;min-height:40px}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.modal-btns{display:flex;gap:4px;justify-content:flex-end;margin-top:10px}
.badge{display:inline-block;padding:2px 6px;border-radius:7px;font-size:8px;font-weight:600}
.dot{display:inline-block;width:6px;height:6px;border-radius:50%}
select option{background:#0A0E17}
.sr{display:grid;grid-template-columns:55px 46px 46px 1fr 60px 40px 44px;gap:3px;padding:6px;border-radius:5px;align-items:center;font-size:9px}
.sr:hover{background:rgba(0,229,160,.02)}
.ath-sel{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.ath-chip{padding:4px 9px;border-radius:14px;font-size:9px;font-weight:600;border:1px solid #1E293B;background:transparent;color:#64748B;transition:.2s}
.ath-chip:hover{border-color:#00E5A0}.ath-chip.on{background:#00E5A018;border-color:#00E5A0;color:#00E5A0}

/* Calendar */
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-h{text-align:center;font-size:8px;color:#64748B;padding:4px 0;font-weight:600}
.cal-d{background:#0d1422;border-radius:6px;padding:6px 4px;min-height:68px;cursor:pointer;transition:.2s;border:1px solid transparent;position:relative}
.cal-d:hover{border-color:#1E293B}.cal-d.today{border-color:#00E5A066}
.cal-d.has-actual{border-left:2px solid #00E5A0}
.cal-dn{font-size:9px;color:#64748B;margin-bottom:3px}.cal-dn.today{color:#00E5A0;font-weight:700}
.cal-ev{font-size:7px;padding:1px 3px;border-radius:3px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cal-plan{border-left:2px solid transparent;padding-left:2px;opacity:.7}
.cal-actual{border-left:2px solid #00E5A0;padding-left:2px;font-weight:600}
.cal-sep{height:1px;background:#1E293B;margin:2px 0}
/* Calendar layer toggle */
.cal-toggle{display:flex;gap:4px;margin-bottom:8px}
.cal-toggle button{padding:3px 8px;border-radius:10px;font-size:8px;font-weight:600;border:1px solid #1E293B;background:transparent;color:#64748B;transition:.2s}
.cal-toggle button.on{border-color:currentColor}

/* XP / Streaks / Gamification */
.xp-bar{background:#1E293B;border-radius:6px;height:8px;overflow:hidden;margin-top:4px}
.xp-fill{height:100%;border-radius:6px;transition:width .5s ease}
.streak-badge{display:inline-flex;align-items:center;gap:3px;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700;animation:streak .5s ease}
.lvl{font-size:11px;font-weight:800;font-family:monospace}

/* Chart containers */
.chart-wrap{position:relative;width:100%;overflow:hidden}
.chart-wrap svg{display:block}

svg text{font-family:-apple-system,sans-serif}
.toast{position:fixed;bottom:16px;right:16px;background:#111827;border:1px solid #00E5A0;border-radius:7px;padding:8px 14px;font-size:11px;color:#00E5A0;z-index:300;animation:fi .3s ease}
.toast.err{border-color:#FF4757;color:#FF4757}
.toast.xp-toast{border-color:#F59E0B;color:#F59E0B}
.empty{text-align:center;color:#64748B;padding:18px;font-size:10px}
footer{border-top:1px solid #1E293B;padding:6px 16px;display:flex;justify-content:space-between;align-items:center;font-size:7px;color:#475569}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -14px;padding:0 14px}

/* Library */
.lib-card{background:#0d1422;border:1px solid #1E293B;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:border-color .2s}
.lib-card:hover{border-color:#3B82F6}
.lib-top{display:flex;align-items:flex-start;gap:10px}
.lib-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.lib-info{flex:1;min-width:0}
.lib-title{font-size:11px;font-weight:700;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lib-desc{font-size:8px;color:#94A3B8;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.lib-meta{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;align-items:center}
.lib-tag{display:inline-block;padding:1px 6px;border-radius:8px;font-size:7px;font-weight:600;background:#1E293B;color:#94A3B8}
.lib-filter{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}

/* Comments */
.cmt-thread{margin-bottom:10px}
.cmt-card{background:#0d1422;border:1px solid #1E293B;border-radius:8px;padding:10px 12px;margin-bottom:4px;position:relative}
.cmt-card.reply{margin-left:24px;border-left:2px solid #1E293B}
.cmt-head{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.cmt-role{display:inline-block;padding:1px 6px;border-radius:8px;font-size:7px;font-weight:700}
.cmt-role.coach{background:#F59E0B22;color:#F59E0B;border:1px solid #F59E0B33}
.cmt-role.athlete{background:#0EA5E922;color:#0EA5E9;border:1px solid #0EA5E933}
.cmt-author{font-size:9px;font-weight:700}
.cmt-date{font-size:7px;color:#64748B;margin-left:auto}
.cmt-body{font-size:10px;line-height:1.5;color:#CBD5E1;white-space:pre-wrap;word-break:break-word}
.cmt-ctx{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:5px;font-size:7px;background:#1E293B;color:#64748B;margin-bottom:4px}
.cmt-actions{display:flex;gap:6px;margin-top:6px;font-size:8px}
.cmt-actions button{background:none;border:none;color:#64748B;font-size:8px;cursor:pointer;padding:2px 4px;transition:color .2s}
.cmt-actions button:hover{color:#00E5A0}
.cmt-unread{position:absolute;top:8px;right:8px;width:6px;height:6px;border-radius:50%;background:#00E5A0}

/* ===== RESPONSIVE: Mobile â‰¤ 640px ===== */
@media(max-width:640px){
  header{padding:0 12px}
  nav.desktop-nav{display:none}
  .bottom-nav{display:block}
  .hi .sb{font-size:7px;padding:2px 6px}
  #td{display:none}
  main{padding:10px 10px calc(66px + env(safe-area-inset-bottom,0)) 10px}
  footer{display:none}
  .g4{grid-template-columns:1fr 1fr;gap:6px}
  .g3{grid-template-columns:1fr 1fr 1fr;gap:6px}
  .cd{padding:12px;border-radius:8px;margin-bottom:8px}
  .mt-v{font-size:16px}
  .btn{padding:8px 14px;font-size:11px;border-radius:8px}
  .btn-sm{padding:6px 10px;font-size:9px}
  .btns{gap:6px}
  .sr{grid-template-columns:1fr;gap:2px;padding:10px;border:1px solid #1E293B;border-radius:8px;margin-bottom:4px;position:relative}
  .sr-mob-top{display:flex;align-items:center;gap:6px;font-size:10px}
  .sr-mob-mid{font-size:11px;padding:2px 0;line-height:1.4}
  .sr-mob-bot{display:flex;align-items:center;gap:8px;font-size:9px;color:#64748B}
  .sr-del{position:absolute;top:8px;right:8px}
  .cal{gap:2px}
  .cal-d{min-height:44px;padding:4px 2px;border-radius:4px}
  .cal-dn{font-size:8px;margin-bottom:1px}
  .cal-ev{font-size:6px;padding:1px 2px;margin-bottom:1px}
  .cal-sep{margin:1px 0}
  .modal-bg{align-items:flex-end}
  .modal{width:100%;max-width:100%;border-radius:16px 16px 0 0;max-height:92vh;max-height:92dvh;padding:20px 16px calc(16px + env(safe-area-inset-bottom,0))}
  .modal h3{font-size:15px;margin-bottom:12px}
  .fg{margin-bottom:10px}
  .fg label{font-size:10px;margin-bottom:3px}
  .fg input,.fg select,.fg textarea{padding:10px 12px;font-size:16px;border-radius:8px}
  .fg-row{gap:8px}.fg-row3{gap:8px}
  .modal-btns{gap:6px;margin-top:14px}
  .modal-btns .btn{flex:1;justify-content:center;padding:12px;font-size:13px}
  .ath-chip{padding:6px 12px;font-size:10px;border-radius:16px}
  .toast{bottom:calc(66px + env(safe-area-inset-bottom,0));right:10px;left:10px;text-align:center}
  table{min-width:520px}
  th{padding:6px 8px;font-size:9px}
  td{padding:8px 8px;font-size:11px}
  #cp svg{max-width:100%}
  /* Library mobile */
  .lib-card{padding:10px}
  .lib-icon{width:32px;height:32px;font-size:14px}
  .lib-title{font-size:12px}
  .lib-desc{font-size:9px}
  /* Comments mobile */
  .cmt-card{padding:10px}
  .cmt-card.reply{margin-left:16px}
  .cmt-body{font-size:11px}
  .cmt-actions button{font-size:9px;padding:4px 6px}
}
@media(max-width:375px){
  .g4{grid-template-columns:1fr 1fr}
  .mt-v{font-size:14px}.mt-l{font-size:7px}
  .logo-t{font-size:12px}
  .btn{padding:7px 12px;font-size:10px}
  .modal{padding:16px 12px calc(12px + env(safe-area-inset-bottom,0))}
  .cal-d{min-height:38px;padding:3px 1px}
  .cal-ev{font-size:5px}
}
@media(min-width:1024px){
  .bottom-nav{display:none !important}
  nav.desktop-nav{display:flex !important}
  main{padding:16px 20px 40px}
}
</style>
</head>
<body>
<div id="login"><div class="lb">
<div style="font-size:28px;margin-bottom:8px">â›µ</div>
<h1>OAR<b>CRAFT</b></h1><div class="sub">v0.9 â€” Library &amp; Comments</div>
<input id="ti" maxlength="8" placeholder="ãƒãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰" autocomplete="off" inputmode="text">
<button class="btn btn-p" style="width:100%;padding:12px;font-size:14px" onclick="joinT()">å‚åŠ </button>
<div class="or">â€” ã¾ãŸã¯ â€”</div>
<button class="btn btn-s" style="width:100%;padding:10px;font-size:12px" onclick="createT()">æ–°è¦ãƒãƒ¼ãƒ ä½œæˆ</button>
<div class="or" style="margin-top:12px"><button class="btn btn-s" style="width:100%;padding:8px;font-size:11px;color:#475569" onclick="goOff()">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰</button></div>
<div id="ls"></div>
</div></div>

<div id="app">
<header><div class="hdr">
<div class="logo"><div class="logo-i">â›µ</div><div class="logo-t">OAR<b>CRAFT</b></div></div>
<nav class="desktop-nav" id="nv"></nav>
<div class="hi"><span id="si"></span><span id="td" style="font-size:8px;color:#64748B;font-family:monospace"></span></div>
</div></header>
<main id="mn"></main>
<div id="modal"></div><div id="toast"></div>
<nav class="bottom-nav" id="bnv"><div class="bottom-nav-inner" id="bnvi"></div></nav>
<footer><span>OARCRAFT v0.9</span><span id="fi"></span></footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
var FBC={apiKey:"AIzaSyCWZ4njD2g8kiUzvZJyS-Q82OcbrqHAHck",authDomain:"oarcraft-4c6eb.firebaseapp.com",databaseURL:"https://oarcraft-4c6eb-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"oarcraft-4c6eb",storageBucket:"oarcraft-4c6eb.firebasestorage.app",messagingSenderId:"765443196894",appId:"1:765443196894:web:c684f6e2df3660fdfcbf4f"};

var CATS=[{id:"OTW",nm:"æ°´ä¸Š",ic:"ğŸš£",c:"#0EA5E9"},{id:"ERG",nm:"ã‚¨ãƒ«ã‚´",ic:"ğŸ‹ï¸",c:"#00E5A0"},{id:"STR",nm:"ç­‹ãƒˆãƒ¬",ic:"ğŸ’ª",c:"#F59E0B"},{id:"CORE",nm:"ä½“å¹¹",ic:"ğŸ§˜",c:"#8B5CF6"},{id:"RUN",nm:"ãƒ©ãƒ³",ic:"ğŸƒ",c:"#EF4444"},{id:"BIKE",nm:"ãƒã‚¤ã‚¯",ic:"ğŸš´",c:"#22C55E"},{id:"OTHER",nm:"ãã®ä»–",ic:"ğŸ“Œ",c:"#64748B"}];
function catOf(id){return CATS.find(function(c){return c.id===id})||CATS[6]}
function catBdg(id){var c=catOf(id);return'<span class="badge" style="background:'+c.c+'18;color:'+c.c+';border:1px solid '+c.c+'33">'+c.ic+'</span>'}
function zoneBdg(z){var cs={UT1:"#3B82F6",UT2:"#22C55E",AT:"#F59E0B",VO2:"#EF4444",Race:"#00E5A0",AN:"#8B5CF6"};var c=cs[z]||"#475569";return z&&z!=="â€”"?'<span class="badge" style="background:'+c+'18;color:'+c+'">'+z+'</span>':''}
var DKS=["mon","tue","wed","thu","fri","sat","sun"],DLBS=["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];
var DEF_PL=[{dy:"æœˆ",am:"UT1 æ°´ä¸Š 16-18km",pm:"ã‚¦ã‚§ã‚¤ãƒˆ",z:"UT1",l:3},{dy:"ç«",am:"AT ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«",pm:"ä½“å¹¹",z:"AT",l:5},{dy:"æ°´",am:"UT1 æ°´ä¸Š 14-16km",pm:"ã‚¦ã‚§ã‚¤ãƒˆ",z:"UT1",l:3},{dy:"æœ¨",am:"VO2max 1000mÃ—5-6",pm:"è£œå¼·",z:"VO2",l:5},{dy:"é‡‘",am:"UT1 æ°´ä¸Šï¼ˆè»½ã‚ï¼‰",pm:"ã‚¹ãƒˆãƒ¬ãƒƒãƒ",z:"UT1",l:2},{dy:"åœŸ",am:"ãƒ¬ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹",pm:"ã‚¦ã‚§ã‚¤ãƒˆ",z:"Race",l:4},{dy:"æ—¥",am:"OFF",pm:"â€”",z:"OFF",l:0}];

var db=null,tc=null,tr=null,isOn=false;
var crew=[],sessions=[],plan=[],ergTests=[],rpe=[],library=[],comments=[],teamMeta={name:"",boatName:""};
var curTab="dash";

// ====== HELPERS ======
function $(id){return document.getElementById(id)}
function esc(s){if(!s)return"";var d=document.createElement("div");d.textContent=s;return d.innerHTML}
function fmtD(d){if(!d)return"â€”";var p=d.split("-");return(p[1]||"")+"/"+(p[2]||"")}
function today(){return new Date().toISOString().slice(0,10)}
function toast(m,cls){var t=$("toast");t.innerHTML='<div class="toast '+(cls||"")+'">'+m+'</div>';setTimeout(function(){t.innerHTML=""},2200)}
function sc(s){return{good:"#00E5A0",watch:"#FFB020",injury:"#FF4757"}[s]||"#64748B"}
function dot(s){return'<span class="dot" style="background:'+sc(s)+'"></span>'}
function trS(t){return t==="up"?'<span style="color:#00E5A0">â–²</span>':t==="down"?'<span style="color:#FF4757">â–¼</span>':'â”'}
function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,5)}
function _s(tag,a,p){var e=document.createElementNS("http://www.w3.org/2000/svg",tag);if(a)for(var k in a)e.setAttribute(k,a[k]);if(p)p.appendChild(e);return e}
function mkS(el,w,h){el.innerHTML="";var s=_s("svg",{width:"100%",height:h,viewBox:"0 0 "+w+" "+h});el.appendChild(s);return s}
function openM(h){$("modal").innerHTML='<div class="modal-bg" onclick="if(event.target===this)closeM()"><div class="modal">'+h+'</div></div>'}
function closeM(){$("modal").innerHTML=""}
function mC(l,v,u,c){return'<div class="cd"><div class="mt"><div class="mt-l">'+l+'</div><div class="mt-v" style="color:'+c+'">'+v+'<span class="mt-u"> '+u+'</span></div></div></div>'}
function crewNames(){return crew.filter(function(c){return c.seat!=="Cox"}).map(function(c){return c.nm})}
function objToArr(o){if(!o)return[];if(Array.isArray(o))return o;return Object.keys(o).map(function(k){var v=o[k];v._id=k;return v})}

// ====== DATA LAYER ======
function saveItem(p,id,d){d.updated=Date.now();if(isOn&&tr)tr.child(p+"/"+id).set(d);else{var o=JSON.parse(localStorage.getItem("oc_"+p)||"{}");o[id]=d;localStorage.setItem("oc_"+p,JSON.stringify(o))}}
function delItem(p,id){if(isOn&&tr)tr.child(p+"/"+id).remove();else{var o=JSON.parse(localStorage.getItem("oc_"+p)||"{}");delete o[id];localStorage.setItem("oc_"+p,JSON.stringify(o))}}

// ====== GAMIFICATION ======
function calcXP(){return sessions.length*10+rpe.length*5+crew.length*15+library.length*5+comments.length*3}
function calcLevel(xp){if(xp<100)return{lv:1,nm:"ãƒãƒ¼ãƒ“ã‚¹",next:100,c:"#64748B"};if(xp<300)return{lv:2,nm:"ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼",next:300,c:"#3B82F6"};if(xp<600)return{lv:3,nm:"ã‚¢ã‚¹ãƒªãƒ¼ãƒˆ",next:600,c:"#0EA5E9"};if(xp<1000)return{lv:4,nm:"ã‚¨ãƒªãƒ¼ãƒˆ",next:1000,c:"#00E5A0"};if(xp<2000)return{lv:5,nm:"ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³",next:2000,c:"#F59E0B"};return{lv:6,nm:"ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰",next:9999,c:"#FF4757"}}
function calcStreak(){var dates={};sessions.forEach(function(s){if(s.d)dates[s.d]=true});rpe.forEach(function(r){if(r.d)dates[r.d]=true});var streak=0,d=new Date();for(var i=0;i<365;i++){var ds=d.toISOString().slice(0,10);if(dates[ds])streak++;else if(i>0)break;d.setDate(d.getDate()-1)}return streak}
function streakColor(s){return s>=14?"#FF4757":s>=7?"#F59E0B":s>=3?"#00E5A0":"#64748B"}

// ====== CHART HELPERS ======
function getWeekDates(weeksBack){
  var arr=[];var d=new Date();var dow=d.getDay()||7;
  d.setDate(d.getDate()-(dow-1)-weeksBack*7);
  for(var w=0;w<(weeksBack+1);w++){var wStart=new Date(d);wStart.setDate(d.getDate()+w*7);arr.push(wStart.toISOString().slice(0,10))}
  return arr
}
function sessInWeek(wStart){
  var ws=new Date(wStart),we=new Date(wStart);we.setDate(ws.getDate()+6);
  var wes=we.toISOString().slice(0,10);
  return sessions.filter(function(s){return s.d>=wStart&&s.d<=wes})
}

// Draw bar chart (weekly volume)
function drawBarChart(el,title,weeksBack){
  if(!el)return;var weeks=getWeekDates(weeksBack||7);
  var data=weeks.map(function(w){var ss=sessInWeek(w);var dur=0,dist=0,cnt=0;
    ss.forEach(function(s){dur+=(s.dur||0);dist+=(s.dist||0);cnt++});
    return{w:w,dur:dur,dist:dist,cnt:cnt}});
  var cw=el.clientWidth||320,W=Math.max(cw,280),H=160,ml=36,mr=12,mt=24,mb=28;
  var g=mkS(el,W,H);
  var maxV=Math.max.apply(null,data.map(function(d){return d.dur}))||60;
  maxV=Math.ceil(maxV/30)*30||60;
  var bw=Math.max(((W-ml-mr)/data.length)-4,8),gap=((W-ml-mr)-bw*data.length)/(data.length);

  // Title
  _s("text",{x:ml,y:14,fill:"#94A3B8","font-size":"9","font-weight":"600"},g).textContent=title||"é€±é–“ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“(åˆ†)";
  // Grid lines
  for(var i=0;i<=3;i++){var yy=mt+(H-mt-mb)*(1-i/3);
    _s("line",{x1:ml,y1:yy,x2:W-mr,y2:yy,stroke:"#1E293B","stroke-width":"1"},g);
    _s("text",{x:ml-4,y:yy+3,"text-anchor":"end",fill:"#475569","font-size":"7"},g).textContent=Math.round(maxV*i/3)}
  // Bars
  data.forEach(function(d,i){var x=ml+i*(bw+gap)+gap/2;
    var bh=Math.max((d.dur/maxV)*(H-mt-mb),1);var y=H-mb-bh;
    var c=d.dur>0?"#00E5A0":"#1E293B";
    _s("rect",{x:x,y:y,width:bw,height:bh,fill:c,rx:"3",opacity:".8"},g);
    if(d.dur>0)_s("text",{x:x+bw/2,y:y-3,"text-anchor":"middle",fill:"#00E5A0","font-size":"7","font-weight":"700"},g).textContent=d.dur;
    var lbl=d.w.slice(5).replace("-","/");
    _s("text",{x:x+bw/2,y:H-mb+12,"text-anchor":"middle",fill:"#64748B","font-size":"7"},g).textContent=lbl})
}

// Draw zone radar chart
function drawRadarChart(el,sessArr,title){
  if(!el)return;
  var zones=["UT1","UT2","AT","VO2","Race","AN"];
  var zoneColors={UT1:"#3B82F6",UT2:"#22C55E",AT:"#F59E0B",VO2:"#EF4444",Race:"#00E5A0",AN:"#8B5CF6"};
  var counts={};zones.forEach(function(z){counts[z]=0});
  sessArr.forEach(function(s){if(counts.hasOwnProperty(s.zone))counts[s.zone]++});
  var maxC=Math.max.apply(null,zones.map(function(z){return counts[z]}))||1;

  var cw=el.clientWidth||240,sz=Math.min(cw,240),W=sz,H=sz+16;
  var g=mkS(el,W,H);var cx=W/2,cy=(H-16)/2+10,r=sz/2-30;
  var n=zones.length;

  if(title)_s("text",{x:cx,y:12,"text-anchor":"middle",fill:"#94A3B8","font-size":"9","font-weight":"600"},g).textContent=title;

  // Grid rings
  [0.25,0.5,0.75,1].forEach(function(s){var pts=[];for(var i=0;i<n;i++){var a=-Math.PI/2+2*Math.PI*i/n;pts.push((cx+Math.cos(a)*r*s).toFixed(1)+","+(cy+Math.sin(a)*r*s).toFixed(1))}
    _s("polygon",{points:pts.join(" "),fill:"none",stroke:"#1E293B","stroke-width":"1"},g)});
  // Axes
  for(var i=0;i<n;i++){var a=-Math.PI/2+2*Math.PI*i/n;
    _s("line",{x1:cx,y1:cy,x2:cx+Math.cos(a)*r,y2:cy+Math.sin(a)*r,stroke:"#1E293B","stroke-width":"1"},g);
    var lx=cx+Math.cos(a)*(r+14),ly=cy+Math.sin(a)*(r+14);
    var t=_s("text",{x:lx,y:ly+3,"text-anchor":"middle",fill:zoneColors[zones[i]]||"#64748B","font-size":"8","font-weight":"700"},g);t.textContent=zones[i]}
  // Data polygon
  var pts=[];for(var i=0;i<n;i++){var a=-Math.PI/2+2*Math.PI*i/n;var val=counts[zones[i]]/maxC;
    pts.push((cx+Math.cos(a)*r*val).toFixed(1)+","+(cy+Math.sin(a)*r*val).toFixed(1))}
  _s("polygon",{points:pts.join(" "),fill:"#00E5A033",stroke:"#00E5A0","stroke-width":"2"},g);
  // Dots
  for(var i=0;i<n;i++){var a=-Math.PI/2+2*Math.PI*i/n;var val=counts[zones[i]]/maxC;
    if(val>0)_s("circle",{cx:cx+Math.cos(a)*r*val,cy:cy+Math.sin(a)*r*val,r:"3",fill:zoneColors[zones[i]]},g)}
}

// Draw category donut chart
function drawCatDonut(el,sessArr,title){
  if(!el)return;
  var counts={};CATS.forEach(function(c){counts[c.id]=0});
  sessArr.forEach(function(s){counts[s.cat]=(counts[s.cat]||0)+1});
  var total=sessArr.length||1;
  var cw=el.clientWidth||200,sz=Math.min(cw,200),W=sz,H=sz+16;
  var g=mkS(el,W,H);var cx=W/2,cy=(H-16)/2+10,ro=sz/2-20,ri=ro*0.55;

  if(title)_s("text",{x:cx,y:12,"text-anchor":"middle",fill:"#94A3B8","font-size":"9","font-weight":"600"},g).textContent=title;

  var startA=-Math.PI/2;
  CATS.forEach(function(cat){
    var cnt=counts[cat.id];if(!cnt)return;
    var sweep=cnt/total*Math.PI*2;var endA=startA+sweep;
    var x1o=cx+Math.cos(startA)*ro,y1o=cy+Math.sin(startA)*ro;
    var x2o=cx+Math.cos(endA)*ro,y2o=cy+Math.sin(endA)*ro;
    var x1i=cx+Math.cos(endA)*ri,y1i=cy+Math.sin(endA)*ri;
    var x2i=cx+Math.cos(startA)*ri,y2i=cy+Math.sin(startA)*ri;
    var large=sweep>Math.PI?"1":"0";
    var d="M"+x1o+","+y1o+" A"+ro+","+ro+" 0 "+large+",1 "+x2o+","+y2o;
    d+=" L"+x1i+","+y1i+" A"+ri+","+ri+" 0 "+large+",0 "+x2i+","+y2i+" Z";
    _s("path",{d:d,fill:cat.c,opacity:".8"},g);
    // Label
    var midA=startA+sweep/2;var lr=ro+12;
    if(cnt/total>=0.08){var lx=cx+Math.cos(midA)*(ri+(ro-ri)/2),ly=cy+Math.sin(midA)*(ri+(ro-ri)/2);
    _s("text",{x:lx,y:ly+3,"text-anchor":"middle",fill:"#fff","font-size":"7","font-weight":"600"},g).textContent=cat.ic}
    startA=endA});
  // Center text
  _s("text",{x:cx,y:cy+1,"text-anchor":"middle",fill:"#E2E8F0","font-size":"16","font-weight":"800"},g).textContent=total;
  _s("text",{x:cx,y:cy+12,"text-anchor":"middle",fill:"#64748B","font-size":"7"},g).textContent="ä»¶"
}

// Draw weekly distance bar chart
function drawDistChart(el,weeksBack){
  if(!el)return;var weeks=getWeekDates(weeksBack||7);
  var data=weeks.map(function(w){var ss=sessInWeek(w);var dist=0;
    ss.forEach(function(s){dist+=(s.dist||0)});return{w:w,dist:Math.round(dist/1000*10)/10}});
  var cw=el.clientWidth||320,W=Math.max(cw,280),H=140,ml=36,mr=12,mt=24,mb=28;
  var g=mkS(el,W,H);
  var maxV=Math.max.apply(null,data.map(function(d){return d.dist}))||10;
  maxV=Math.ceil(maxV/5)*5||10;
  var bw=Math.max(((W-ml-mr)/data.length)-4,8),gap=((W-ml-mr)-bw*data.length)/(data.length);

  _s("text",{x:ml,y:14,fill:"#94A3B8","font-size":"9","font-weight":"600"},g).textContent="é€±é–“è·é›¢ (km)";
  for(var i=0;i<=3;i++){var yy=mt+(H-mt-mb)*(1-i/3);
    _s("line",{x1:ml,y1:yy,x2:W-mr,y2:yy,stroke:"#1E293B","stroke-width":"1"},g);
    _s("text",{x:ml-4,y:yy+3,"text-anchor":"end",fill:"#475569","font-size":"7"},g).textContent=Math.round(maxV*i/3)}
  data.forEach(function(d,i){var x=ml+i*(bw+gap)+gap/2;
    var bh=Math.max((d.dist/maxV)*(H-mt-mb),1);var y=H-mb-bh;
    _s("rect",{x:x,y:y,width:bw,height:bh,fill:"#0EA5E9",rx:"3",opacity:".75"},g);
    if(d.dist>0)_s("text",{x:x+bw/2,y:y-3,"text-anchor":"middle",fill:"#0EA5E9","font-size":"7","font-weight":"700"},g).textContent=d.dist;
    _s("text",{x:x+bw/2,y:H-mb+12,"text-anchor":"middle",fill:"#64748B","font-size":"7"},g).textContent=d.w.slice(5).replace("-","/")})
}

// ====== FIREBASE ======
function initFB(){try{firebase.initializeApp(FBC);db=firebase.database();return true}catch(e){return false}}
function joinT(){var c=$("ti").value.trim().toUpperCase();if(!c||c.length<3){$("ls").innerHTML='<span style="color:#FF4757">3æ–‡å­—ä»¥ä¸Šå…¥åŠ›</span>';return}
if(!initFB()){goOff();return}$("ls").innerHTML='<span style="color:#F59E0B">æ¥ç¶šä¸­...</span>';
db.ref("teams/"+c).once("value",function(s){if(s.exists()){tc=c;tr=db.ref("teams/"+c);isOn=true;localStorage.setItem("oc_tc",c);startApp()}else{$("ls").innerHTML='<span style="color:#FF4757">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>'}},function(){$("ls").innerHTML='<span style="color:#FF4757">æ¥ç¶šã‚¨ãƒ©ãƒ¼</span>'})}

function createT(){if(!initFB()){goOff();return}
var ch="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",c="";for(var i=0;i<6;i++)c+=ch[Math.floor(Math.random()*ch.length)];
$("ls").innerHTML='<span style="color:#F59E0B">ä½œæˆä¸­...</span>';
var ref=db.ref("teams/"+c);var po={};DEF_PL.forEach(function(d,i){po[DKS[i]]=d});
ref.set({meta:{name:"æ–°è¦ãƒãƒ¼ãƒ ",boatName:"",created:new Date().toISOString()},crew:{},sessions:{},plan:po,ergTests:{},rpe:{},library:{},comments:{}},function(e){
if(e){$("ls").innerHTML='<span style="color:#FF4757">ã‚¨ãƒ©ãƒ¼</span>';return}
tc=c;tr=ref;isOn=true;localStorage.setItem("oc_tc",c);startApp()})}

function goOff(){isOn=false;tc="LOCAL";crew=objToArr(JSON.parse(localStorage.getItem("oc_crew")||"[]"));sessions=objToArr(JSON.parse(localStorage.getItem("oc_sessions")||"[]"));library=objToArr(JSON.parse(localStorage.getItem("oc_library")||"[]"));comments=objToArr(JSON.parse(localStorage.getItem("oc_comments")||"[]"));plan=DEF_PL.slice();rpe=[];startApp()}

function startApp(){$("login").style.display="none";$("app").style.display="block";$("td").textContent=tc;$("si").innerHTML=isOn?'<span class="sb sb-on">ğŸŸ¢ åŒæœŸ</span>':'<span class="sb sb-off">âš« ãƒ­ãƒ¼ã‚«ãƒ«</span>';$("fi").textContent=isOn?"Team: "+tc:"ãƒ­ãƒ¼ã‚«ãƒ«";if(isOn)listen();initNav();render()}

function listen(){
tr.child("meta").on("value",function(s){teamMeta=s.val()||{name:"",boatName:""};render()});
tr.child("crew").on("value",function(s){crew=objToArr(s.val());render()});
tr.child("sessions").on("value",function(s){sessions=objToArr(s.val());sessions.sort(function(a,b){return(b.d||"").localeCompare(a.d||"")});render()});
tr.child("plan").on("value",function(s){var v=s.val();if(v)plan=DKS.map(function(k,i){var d=v[k]||DEF_PL[i];d._id=k;return d});render()});
tr.child("rpe").on("value",function(s){rpe=objToArr(s.val());render()});
tr.child("ergTests").on("value",function(s){ergTests=objToArr(s.val());render()});
tr.child("library").on("value",function(s){library=objToArr(s.val());library.sort(function(a,b){return(b.updated||0)-(a.updated||0)});render()});
tr.child("comments").on("value",function(s){comments=objToArr(s.val());comments.sort(function(a,b){return(a.ts||0)-(b.ts||0)});render()})}

(function(){var s=localStorage.getItem("oc_tc");if(s&&s!=="LOCAL")$("ti").value=s})();

// ====== NAV ======
var tabs=[{id:"dash",lb:"ãƒ›ãƒ¼ãƒ ",ic:"ğŸ "},{id:"crew",lb:"ã‚¯ãƒ«ãƒ¼",ic:"â›µ"},{id:"sess",lb:"è¨˜éŒ²",ic:"ğŸ“"},{id:"rpe",lb:"RPE",ic:"ğŸ˜“"},{id:"cal",lb:"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼",ic:"ğŸ“…"},{id:"lib",lb:"è³‡æ–™",ic:"ğŸ“š"},{id:"cmt",lb:"ã‚³ãƒ¡ãƒ³ãƒˆ",ic:"ğŸ’¬"},{id:"ath",lb:"é¸æ‰‹",ic:"ğŸ‘¤"},{id:"data",lb:"ãƒ‡ãƒ¼ã‚¿",ic:"ğŸ’¾"}];
function initNav(){
$("nv").innerHTML=tabs.map(function(t){return'<button data-t="'+t.id+'"'+(t.id===curTab?' class="on"':'')+'>'+t.ic+' '+t.lb+'</button>'}).join("");
$("nv").onclick=function(e){var b=e.target.closest("button");if(b){curTab=b.dataset.t;render()}};
$("bnvi").innerHTML=tabs.map(function(t){return'<button data-t="'+t.id+'"'+(t.id===curTab?' class="on"':'')+'><span class="bnav-ic">'+t.ic+'</span><span class="bnav-lb">'+t.lb+'</span></button>'}).join("");
$("bnvi").onclick=function(e){var b=e.target.closest("button");if(b){curTab=b.dataset.t;render()}}}

function render(){if(!$("nv"))return;
document.querySelectorAll("nav.desktop-nav button").forEach(function(b){b.className=b.dataset.t===curTab?"on":""});
document.querySelectorAll(".bottom-nav-inner button").forEach(function(b){b.className=b.dataset.t===curTab?"on":""});
var m=$("mn");
if(curTab==="dash")rDash(m);else if(curTab==="crew")rCrew(m);else if(curTab==="sess")rSess(m);
else if(curTab==="rpe")rRpe(m);else if(curTab==="cal")rCal(m);else if(curTab==="lib")rLib(m);else if(curTab==="cmt")rCmt(m);else if(curTab==="ath")rAth(m);else if(curTab==="data")rData(m);
requestAnimationFrame(function(){
  if(curTab==="crew"&&$("cp"))drawPow();
  if(curTab==="dash"){if($("dbar"))drawBarChart($("dbar"),"é€±é–“ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ (åˆ†)",7);if($("ddist"))drawDistChart($("ddist"),7);if($("dradar"))drawRadarChart($("dradar"),sessions,"ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ");if($("ddonut"))drawCatDonut($("ddonut"),sessions,"ã‚«ãƒ†ã‚´ãƒªå†…è¨³")}
  if(curTab==="ath"){if($("aradar")){var as=sessions.filter(function(s){return s.who===selA||s.who==="å…¨å“¡"});drawRadarChart($("aradar"),as,selA+" ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ")}if($("abar")){var as2=sessions.filter(function(s){return s.who===selA||s.who==="å…¨å“¡"});drawAthBar($("abar"),as2)}}
})}

// ====== DASHBOARD (gamified + charts) ======
function rDash(m){var xp=calcXP(),lv=calcLevel(xp),sk=calcStreak(),skc=streakColor(sk);
var h='<div class="tab on">';
// Hero card
h+='<div class="cd" style="text-align:center;padding:20px;border-color:'+lv.c+'33">';
if(teamMeta.boatName)h+='<div style="font-size:11px;color:#64748B;margin-bottom:4px">ğŸš£ '+esc(teamMeta.boatName)+'</div>';
h+='<div class="lvl" style="color:'+lv.c+'">Lv.'+lv.lv+' '+lv.nm+'</div>';
h+='<div class="xp-bar" style="max-width:300px;margin:8px auto"><div class="xp-fill" style="width:'+Math.min(xp/lv.next*100,100)+'%;background:'+lv.c+'"></div></div>';
h+='<div style="font-size:9px;color:#64748B">'+xp+' / '+lv.next+' XP</div>';
h+='<div style="margin-top:12px"><span class="streak-badge" style="background:'+skc+'18;color:'+skc+';border:1px solid '+skc+'33">ğŸ”¥ '+sk+'æ—¥é€£ç¶š</span></div>';
h+='<div style="font-size:8px;color:#475569;margin-top:4px">'+(sk>=7?"ã™ã”ã„ï¼ãƒãƒ¼ãƒ ã®ç¿’æ…£ãŒå®šç€ã—ã¦ã¾ã™":sk>=3?"ã„ã„èª¿å­ï¼ç¶šã‘ã‚ˆã†":"ä»Šæ—¥ã‚‚è¨˜éŒ²ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ä¼¸ã°ãã†")+'</div></div>';
// Quick stats
h+='<div class="g4">'+mC("é¸æ‰‹",crew.length,"å","#00E5A0")+mC("è¨˜éŒ²",sessions.length,"ä»¶","#0EA5E9")+mC("ä»Šé€±",sessThisWeek(),"ä»¶","#F59E0B")+mC("RPE",rpeToday(),"ä»¶","#8B5CF6")+'</div>';
// Quick actions
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>âš¡</em><h2>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2></div></div>';
h+='<div class="btns"><button class="btn btn-p" onclick="curTab=\'sess\';render();setTimeout(function(){openSF(null)},100)">ğŸ“ è¨˜éŒ²è¿½åŠ </button>';
h+='<button class="btn btn-s" style="border-color:'+skc+';color:'+skc+'" onclick="curTab=\'rpe\';render()">ğŸ˜“ RPEå…¥åŠ›</button>';
h+='<button class="btn btn-s" onclick="curTab=\'cal\';render()">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button></div></div>';
// ===== CHARTS =====
h+='<div class="g2"><div class="cd"><div class="chart-wrap" id="dbar"></div></div><div class="cd"><div class="chart-wrap" id="ddist"></div></div></div>';
h+='<div class="g2"><div class="cd" style="display:flex;justify-content:center"><div class="chart-wrap" id="dradar" style="max-width:240px"></div></div><div class="cd" style="display:flex;justify-content:center"><div class="chart-wrap" id="ddonut" style="max-width:200px"></div></div></div>';
// Recent
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“‹</em><h2>æœ€è¿‘ã®è¨˜éŒ²</h2></div></div>';
sessions.slice(0,5).forEach(function(s,i){h+='<div style="display:flex;gap:5px;padding:4px 6px;font-size:9px;align-items:center;border-radius:4px;background:'+(i%2?"transparent":"#0d1422")+'"><span class="mono" style="color:#64748B;width:40px">'+fmtD(s.d)+'</span>'+catBdg(s.cat)+' <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(s.ds||"")+' '+esc(s.nt)+'</span></div>'});
if(!sessions.length)h+='<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’è¿½åŠ ã—ã‚ˆã†ï¼</div>';
h+='</div></div>';m.innerHTML=h}
function sessThisWeek(){var d=new Date(),w=d.getDay()||7,mon=new Date(d);mon.setDate(d.getDate()-(w-1));var ms=mon.toISOString().slice(0,10);return sessions.filter(function(s){return s.d>=ms}).length}
function rpeToday(){return rpe.filter(function(r){return r.d===today()}).length}

// ====== CREW ======
function rCrew(m){var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>â›µ</em><h2>ã‚¯ãƒ«ãƒ¼ç®¡ç†</h2></div><div class="btns"><button class="btn btn-s btn-sm" onclick="editBoat()">ğŸš£ è‰‡åè¨­å®š</button><button class="btn btn-p btn-sm" onclick="openCF(null)">ï¼‹</button></div></div>';
if(teamMeta.boatName)h+='<div style="font-size:12px;font-weight:700;color:#0EA5E9;margin-bottom:8px">ğŸš£ '+esc(teamMeta.boatName)+'</div>';
h+='<div class="table-wrap"><table><thead><tr>';["å¸­","åå‰","2K","kg","W","","",""].forEach(function(x){h+='<th>'+x+'</th>'});
h+='</tr></thead><tbody>';crew.forEach(function(c){var id=c._id||"";h+='<tr style="cursor:pointer" onclick="openCF(\''+id+'\')"><td class="mono" style="color:#00E5A0;font-weight:700;font-size:9px">'+esc(c.seat)+'</td><td style="font-weight:600;font-size:9px">'+esc(c.nm)+'</td><td class="mono" style="font-weight:700;font-size:9px">'+esc(c.erg)+'</td><td class="mono" style="color:#64748B;font-size:9px">'+c.w+'</td><td class="mono" style="color:#64748B;font-size:9px">'+(c.pw||"â€”")+'</td><td>'+dot(c.st)+'</td><td>'+trS(c.tr)+'</td><td><button class="btn btn-d btn-sm" onclick="event.stopPropagation();delCr(\''+id+'\')">Ã—</button></td></tr>'});
h+='</tbody></table></div></div><div class="cd"><div class="sh"><div class="sh-l"><em>âš¡</em><h2>ãƒ‘ãƒ¯ãƒ¼</h2></div></div><div id="cp"></div></div></div>';m.innerHTML=h}

function editBoat(){var h='<h3>ğŸš£ è‰‡åè¨­å®š</h3><div class="fg"><label>è‰‡åï¼ˆãƒœãƒ¼ãƒˆåï¼‰</label><input id="bn" value="'+esc(teamMeta.boatName||"")+'"></div><div class="fg"><label>ãƒãƒ¼ãƒ å</label><input id="tn" value="'+esc(teamMeta.name||"")+'"></div><div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveBoat()">ä¿å­˜</button></div>';openM(h)}
function saveBoat(){var o={name:$("tn").value.trim(),boatName:$("bn").value.trim(),created:teamMeta.created||new Date().toISOString()};if(isOn&&tr)tr.child("meta").set(o);teamMeta=o;closeM();render();toast("â›µ è‰‡åæ›´æ–°ï¼","xp-toast")}

function openCF(id){var c=id?crew.find(function(x){return x._id===id}):null;if(!c)c={seat:"",nm:"",erg:"",w:75,pw:0,st:"good",tr:"flat"};
var h='<h3>â›µ '+(id?"ç·¨é›†":"è¿½åŠ ")+'</h3><div class="fg-row"><div class="fg"><label>ã‚·ãƒ¼ãƒˆ</label><input id="fs" value="'+esc(c.seat)+'"></div><div class="fg"><label>åå‰</label><input id="fn" value="'+esc(c.nm)+'"></div></div><div class="fg-row3"><div class="fg"><label>2K</label><input id="fe" value="'+esc(c.erg)+'"></div><div class="fg"><label>ä½“é‡</label><input id="fw" type="number" value="'+c.w+'"></div><div class="fg"><label>W</label><input id="fp" type="number" value="'+c.pw+'"></div></div><div class="fg-row"><div class="fg"><label>çŠ¶æ…‹</label><select id="ft"><option value="good"'+(c.st==="good"?" selected":"")+'>Good</option><option value="watch"'+(c.st==="watch"?" selected":"")+'>Watch</option><option value="injury"'+(c.st==="injury"?" selected":"")+'>Injury</option></select></div><div class="fg"><label>å‚¾å‘</label><select id="ftr"><option value="up"'+(c.tr==="up"?" selected":"")+'>â–²</option><option value="flat"'+(c.tr==="flat"?" selected":"")+'>â”</option><option value="down"'+(c.tr==="down"?" selected":"")+'>â–¼</option></select></div></div><div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveCF(\''+(id||"")+"')\">ä¿å­˜</button></div>";openM(h)}
function saveCF(id){var o={seat:$("fs").value.trim()||"?",nm:$("fn").value.trim()||"æœªå…¥åŠ›",erg:$("fe").value.trim()||"â€”",w:parseInt($("fw").value)||0,pw:parseInt($("fp").value)||0,st:$("ft").value,tr:$("ftr").value};if(!id)id=genId();saveItem("crew",id,o);closeM();if(!isOn)render();toast("+15 XP ğŸ‰","xp-toast")}
function delCr(id){if(!confirm("å‰Šé™¤ï¼Ÿ"))return;delItem("crew",id);if(!isOn)render()}
function drawPow(){var el=$("cp");if(!el)return;var rw=crew.filter(function(m){return m.pw>0}).sort(function(a,b){return b.pw-a.pw});if(!rw.length){el.innerHTML='<div class="empty">ãƒ‘ãƒ¯ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</div>';return}
var cw=el.clientWidth||300,W=Math.max(cw,280),H=rw.length*22+16,ml=56,mr=40,mt=8,g=mkS(el,W,H);var mx=Math.max.apply(null,rw.map(function(m){return m.pw}))+30,mn=Math.min.apply(null,rw.map(function(m){return m.pw}))-40;
rw.forEach(function(m,i){var y=mt+i*22,bw=Math.max((m.pw-mn)/(mx-mn)*(W-ml-mr),3),c=m.pw>=440?"#00E5A0":m.pw>=410?"#0EA5E9":"#3B82F6";_s("text",{x:ml-3,y:y+10,"text-anchor":"end",fill:"#94A3B8","font-size":"8"},g).textContent=(m.nm||"").split(" ")[0];_s("rect",{x:ml,y:y,width:bw,height:11,fill:c,rx:"2",opacity:".85"},g);_s("text",{x:ml+bw+3,y:y+10,fill:c,"font-size":"8","font-weight":"600"},g).textContent=m.pw+"W"})}

// ====== SESSIONS ======
var sf="ALL";
function rSess(m){var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“</em><h2>è¨˜éŒ²</h2></div><button class="btn btn-p" onclick="openSF(null)">ï¼‹ è¨˜éŒ²</button></div>';
h+='<div class="btns" style="margin-bottom:8px"><button class="btn '+(sf==="ALL"?"btn-p":"btn-s")+' btn-sm" onclick="sf=\'ALL\';render()">å…¨</button>';
CATS.forEach(function(c){h+='<button class="btn '+(sf===c.id?"btn-p":"btn-s")+' btn-sm" onclick="sf=\''+c.id+'\';render()">'+c.ic+'</button>'});h+='</div>';
var fl=sessions.filter(function(s){return sf==="ALL"||s.cat===sf});
fl.forEach(function(s,i){var id=s._id||"";
var isMob=window.innerWidth<=640;
if(isMob){
h+='<div class="sr" style="background:#0d1422;cursor:pointer" onclick="openSF(\''+id+'\')">';
h+='<div class="sr-mob-top"><span class="mono" style="color:#64748B;font-size:9px">'+fmtD(s.d)+'</span>'+catBdg(s.cat)+zoneBdg(s.zone)+'<span style="font-size:9px;color:#64748B;margin-left:auto">'+esc(s.who||"")+'</span></div>';
h+='<div class="sr-mob-mid">'+(s.ds||"")+(s.sp&&s.sp!=="â€”"?' <span class="mono" style="color:#00E5A0">'+esc(s.sp)+'</span>':"")+' <span style="color:#94A3B8">'+esc(s.nt)+'</span></div>';
h+='<div class="sr-mob-bot">'+(s.dur?'<span>â± '+s.dur+'åˆ†</span>':'')+(s.dist?'<span>ğŸ“ '+(s.dist>=1000?(s.dist/1000).toFixed(1)+'km':s.dist+'m')+'</span>':'')+(s.r?'<span>ğŸ”„ '+s.r+'spm</span>':'')+'</div>';
h+='<button class="btn btn-d btn-sm sr-del" onclick="event.stopPropagation();delSs(\''+id+'\')">Ã—</button></div>';
}else{
h+='<div class="sr" style="background:'+(i%2===0?"#0d1422":"transparent")+';cursor:pointer" onclick="openSF(\''+id+'\')"><span class="mono" style="font-size:8px">'+fmtD(s.d)+'</span>'+catBdg(s.cat)+zoneBdg(s.zone)+'<span style="font-size:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(s.ds||"")+(s.sp&&s.sp!=="â€”"?' <span class="mono" style="color:#00E5A0">'+esc(s.sp)+'</span>':"")+' '+esc(s.nt)+'</span><span style="font-size:8px;color:#64748B">'+esc(s.who||"")+'</span><span class="mono" style="font-size:8px;color:#64748B">'+(s.dur?s.dur+'m':'')+'</span><button class="btn btn-d btn-sm" onclick="event.stopPropagation();delSs(\''+id+'\')">Ã—</button></div>';
}});
if(!fl.length)h+='<div class="empty">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';h+='</div></div>';m.innerHTML=h}

function openSF(id){var s=id?sessions.find(function(x){return x._id===id}):null;
if(!s)s={d:today(),cat:"OTW",zone:"UT1",who:"å…¨å“¡",ds:"",sp:"",r:0,nt:"",hr:0,dist:0,dur:0};
var zones=["UT2","UT1","AT","VO2","Race","AN","â€”"];var names=["å…¨å“¡"].concat(crewNames());
var h='<h3>ğŸ“ '+(id?"ç·¨é›†":"è¿½åŠ ")+'</h3><div class="fg"><label>ã‚«ãƒ†ã‚´ãƒª</label><select id="scat">';CATS.forEach(function(c){h+='<option value="'+c.id+'"'+(s.cat===c.id?" selected":"")+'>'+c.ic+' '+c.nm+'</option>'});
h+='</select></div><div class="fg-row3"><div class="fg"><label>æ—¥ä»˜</label><input id="sd" type="date" value="'+s.d+'"></div><div class="fg"><label>ã‚¾ãƒ¼ãƒ³</label><select id="sz">';zones.forEach(function(z){h+='<option value="'+z+'"'+(s.zone===z?" selected":"")+'>'+z+'</option>'});
h+='</select></div><div class="fg"><label>å¯¾è±¡</label><select id="sw">';names.forEach(function(n){h+='<option value="'+n+'"'+((s.who||"å…¨å“¡")===n?" selected":"")+'>'+n+'</option>'});
h+='</select></div></div><div class="fg-row3"><div class="fg"><label>å†…å®¹</label><input id="sds" value="'+esc(s.ds)+'"></div><div class="fg"><label>è·é›¢(m)</label><input id="sdi" type="number" value="'+(s.dist||0)+'"></div><div class="fg"><label>æ™‚é–“(åˆ†)</label><input id="sdu" type="number" value="'+(s.dur||0)+'"></div></div>';
h+='<div class="fg-row3"><div class="fg"><label>Split</label><input id="ssp" value="'+esc(s.sp)+'"></div><div class="fg"><label>Rate</label><input id="sr" type="number" value="'+(s.r||0)+'"></div><div class="fg"><label>HR</label><input id="shr" type="number" value="'+(s.hr||0)+'"></div></div>';
h+='<div class="fg"><label>ãƒ¡ãƒ¢</label><textarea id="snt">'+esc(s.nt)+'</textarea></div><div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveSF(\''+(id||"")+"')\">ä¿å­˜</button></div>";openM(h)}
function saveSF(id){var o={d:$("sd").value||today(),cat:$("scat").value,zone:$("sz").value,who:$("sw").value,ds:$("sds").value.trim(),sp:$("ssp").value.trim(),r:parseInt($("sr").value)||0,hr:parseInt($("shr").value)||0,dist:parseInt($("sdi").value)||0,dur:parseInt($("sdu").value)||0,nt:$("snt").value.trim()};if(!id)id=genId();saveItem("sessions",id,o);closeM();if(!isOn)render();toast("+10 XP ğŸ“","xp-toast")}
function delSs(id){if(!confirm("å‰Šé™¤ï¼Ÿ"))return;delItem("sessions",id);if(!isOn)render()}

// ====== RPE ======
function rRpe(m){var td=today(),names=crewNames();
var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ˜“</em><h2>ä¸»è¦³ç–²åŠ´åº¦ (RPE)</h2></div><button class="btn btn-p" onclick="openRpeF()">ï¼‹ å…¥åŠ›</button></div><div class="sh-s">1ã€œ10 â€” 7ä»¥ä¸Šã¯è¦æ³¨æ„ ğŸ”´</div>';
var tdr=rpe.filter(function(r){return r.d===td});
if(tdr.length){h+='<div style="margin-bottom:10px;font-size:9px;color:#64748B">ğŸ“… ä»Šæ—¥ ('+fmtD(td)+')</div>';
tdr.forEach(function(r){var c=r.v>=8?"#FF4757":r.v>=6?"#F59E0B":"#00E5A0";
h+='<div style="display:flex;align-items:center;gap:6px;padding:4px 6px;margin-bottom:2px;border-radius:4px;background:#0d1422;cursor:pointer" onclick="openRpeEdit(\''+r._id+'\')"><span style="width:56px;font-size:9px;font-weight:600">'+esc(r.who)+'</span><div style="flex:1;background:#1E293B;border-radius:3px;height:12px"><div style="width:'+r.v*10+'%;height:100%;background:'+c+';border-radius:3px"></div></div><span class="mono" style="font-size:12px;font-weight:800;color:'+c+';width:24px;text-align:right">'+r.v+'</span><span style="font-size:8px;color:#64748B;max-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(r.note||"")+'</span></div>'})}
var byD={};rpe.forEach(function(r){if(!byD[r.d])byD[r.d]=[];byD[r.d].push(r)});
var dts=Object.keys(byD).sort().reverse().slice(0,10);
h+='<div style="margin-top:10px;font-size:9px;color:#64748B">ğŸ“‹ å±¥æ­´ï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰</div>';
dts.forEach(function(dt){var avg=0;byD[dt].forEach(function(r){avg+=r.v});avg=Math.round(avg/byD[dt].length*10)/10;var ac=avg>=8?"#FF4757":avg>=6?"#F59E0B":"#00E5A0";
h+='<div style="padding:5px 6px;margin-top:4px;border-radius:4px;background:#0d1422"><div style="display:flex;justify-content:space-between;font-size:9px;margin-bottom:3px"><span class="mono" style="color:#64748B">'+fmtD(dt)+'</span><span>avg <span class="mono" style="color:'+ac+';font-weight:800">'+avg+'</span></span></div>';
byD[dt].forEach(function(r){var c=r.v>=8?"#FF4757":r.v>=6?"#F59E0B":"#00E5A0";h+='<div style="display:flex;align-items:center;gap:4px;font-size:8px;padding:1px 0;cursor:pointer" onclick="openRpeEdit(\''+r._id+'\')"><span style="width:50px">'+esc(r.who)+'</span><div style="flex:1;background:#1E293B;border-radius:2px;height:8px"><div style="width:'+r.v*10+'%;height:100%;background:'+c+';border-radius:2px"></div></div><span class="mono" style="color:'+c+';width:16px;text-align:right">'+r.v+'</span></div>'});h+='</div>'});
if(!dts.length)h+='<div class="empty">RPEã‚’å…¥åŠ›ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ä¼¸ã°ãã† ğŸ”¥</div>';
h+='</div></div>';m.innerHTML=h}

function openRpeF(){var td=today(),names=crewNames();
var h='<h3>ğŸ˜“ RPEä¸€æ‹¬å…¥åŠ›</h3><div class="fg"><label>æ—¥ä»˜</label><input id="rd" type="date" value="'+td+'"></div>';
names.forEach(function(n,i){var ex=rpe.find(function(r){return r.d===td&&r.who===n});var v=ex?ex.v:5;
h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="width:60px;font-size:9px;font-weight:600">'+esc(n)+'</span><input id="rv'+i+'" type="range" min="1" max="10" value="'+v+'" style="flex:1;accent-color:#00E5A0" oninput="$(\'rl'+i+'\').textContent=this.value;$(\'rl'+i+'\').style.color=this.value>=8?\'#FF4757\':this.value>=6?\'#F59E0B\':\'#00E5A0\'"><span id="rl'+i+'" class="mono" style="font-size:13px;font-weight:800;width:22px;text-align:center;color:'+(v>=8?"#FF4757":v>=6?"#F59E0B":"#00E5A0")+'">'+v+'</span><input id="rn'+i+'" placeholder="ãƒ¡ãƒ¢" value="'+esc(ex?ex.note||"":"")+'" style="width:60px;background:#0A0E17;border:1px solid #1E293B;border-radius:4px;padding:3px 5px;color:#E2E8F0;font-size:8px"></div>'});
h+='<div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveRpe()">ä¿å­˜ (+5 XP)</button></div>';openM(h)}

function saveRpe(){var d=$("rd").value,names=crewNames();
names.forEach(function(n,i){var v=parseInt($("rv"+i).value)||5,note=$("rn"+i).value.trim();
var id=d.replace(/-/g,"")+n.replace(/\s/g,"").slice(0,4);
saveItem("rpe",id,{d:d,who:n,v:v,note:note})});
closeM();if(!isOn)render();toast("+5 XP ğŸ˜“ RPEè¨˜éŒ²å®Œäº†ï¼","xp-toast")}

function openRpeEdit(id){var r=rpe.find(function(x){return x._id===id});if(!r)return;
var c=r.v>=8?"#FF4757":r.v>=6?"#F59E0B":"#00E5A0";
var h='<h3>ğŸ˜“ RPEç·¨é›† â€” '+esc(r.who)+'</h3><div class="fg"><label>æ—¥ä»˜</label><input id="red" type="date" value="'+r.d+'"></div>';
h+='<div style="display:flex;align-items:center;gap:8px;margin:12px 0"><span style="font-size:10px">ç–²åŠ´åº¦</span><input id="rev" type="range" min="1" max="10" value="'+r.v+'" style="flex:1;accent-color:#00E5A0" oninput="$(\'rel\').textContent=this.value;$(\'rel\').style.color=this.value>=8?\'#FF4757\':this.value>=6?\'#F59E0B\':\'#00E5A0\'"><span id="rel" class="mono" style="font-size:18px;font-weight:800;color:'+c+'">'+r.v+'</span></div>';
h+='<div class="fg"><label>ãƒ¡ãƒ¢</label><input id="ren" value="'+esc(r.note||"")+'"></div>';
h+='<div class="modal-btns"><button class="btn btn-d" onclick="delRpe(\''+id+'\')">å‰Šé™¤</button><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveRpeEdit(\''+id+'\')">æ›´æ–°</button></div>';openM(h)}
function saveRpeEdit(id){saveItem("rpe",id,{d:$("red").value,who:rpe.find(function(x){return x._id===id}).who,v:parseInt($("rev").value)||5,note:$("ren").value.trim()});closeM();if(!isOn)render();toast("æ›´æ–°")}
function delRpe(id){delItem("rpe",id);closeM();if(!isOn)render()}

// ====== CALENDAR (dual-layer: plan vs actual) ======
var calMonth=new Date().getMonth(),calYear=new Date().getFullYear();
var calLayer="both"; // "both","plan","actual"
function rCal(m){
var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“…</em><h2>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2></div><div class="btns"><button class="btn btn-s btn-sm" onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--}render()">â—€</button><span style="font-size:11px;font-weight:700;min-width:80px;text-align:center">'+calYear+'å¹´'+(calMonth+1)+'æœˆ</span><button class="btn btn-s btn-sm" onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++}render()">â–¶</button></div></div>';
// Layer toggle
h+='<div class="cal-toggle">';
h+='<button class="'+(calLayer==="both"?"on":"")+'" style="'+(calLayer==="both"?"color:#00E5A0;border-color:#00E5A0":"")+'" onclick="calLayer=\'both\';render()">ğŸ“‹+âœ… ä¸¡æ–¹</button>';
h+='<button class="'+(calLayer==="plan"?"on":"")+'" style="'+(calLayer==="plan"?"color:#F59E0B;border-color:#F59E0B":"")+'" onclick="calLayer=\'plan\';render()">ğŸ“‹ è¨ˆç”»</button>';
h+='<button class="'+(calLayer==="actual"?"on":"")+'" style="'+(calLayer==="actual"?"color:#0EA5E9;border-color:#0EA5E9":"")+'" onclick="calLayer=\'actual\';render()">âœ… å®Ÿç¸¾</button>';
h+='</div>';
// Legend
h+='<div style="display:flex;gap:10px;margin-bottom:6px;font-size:7px;color:#64748B">';
if(calLayer!=="actual")h+='<span><span style="display:inline-block;width:6px;height:6px;border-radius:1px;background:#F59E0B;margin-right:2px;opacity:.6"></span>è¨ˆç”»</span>';
if(calLayer!=="plan")h+='<span><span style="display:inline-block;width:6px;height:6px;border-radius:1px;background:#00E5A0;margin-right:2px"></span>å®Ÿç¸¾</span>';
h+='</div>';
// Week headers
h+='<div class="cal">';DLBS.forEach(function(d){h+='<div class="cal-h">'+d+'</div>'});
var first=new Date(calYear,calMonth,1),startDow=(first.getDay()+6)%7,days=new Date(calYear,calMonth+1,0).getDate(),td2=today();
for(var i=0;i<startDow;i++)h+='<div class="cal-d" style="opacity:.3"></div>';
for(var d=1;d<=days;d++){var ds=calYear+"-"+String(calMonth+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
var daySess=sessions.filter(function(s){return s.d===ds});var dayRpe=rpe.filter(function(r){return r.d===ds});
var dow=(startDow+d-1)%7;var planD=plan[dow];
var isT=ds===td2,hasActual=daySess.length>0;
h+='<div class="cal-d'+(isT?" today":"")+(hasActual?" has-actual":"")+'" onclick="openDayDetail(\''+ds+'\')">';
h+='<div class="cal-dn'+(isT?" today":"")+'">'+d+'</div>';
// PLAN layer
if(calLayer!=="actual"&&planD&&planD.z!=="OFF"){var zc={UT1:"#3B82F6",AT:"#F59E0B",VO2:"#EF4444",Race:"#00E5A0"}[planD.z]||"#475569";
h+='<div class="cal-ev cal-plan" style="background:'+zc+'15;color:'+zc+';border-left-color:'+zc+'">'+esc(planD.am).slice(0,12)+'</div>'}
// Separator if both
if(calLayer==="both"&&planD&&planD.z!=="OFF"&&hasActual)h+='<div class="cal-sep"></div>';
// ACTUAL layer
if(calLayer!=="plan"){
daySess.slice(0,2).forEach(function(s){h+='<div class="cal-ev cal-actual" style="background:'+catOf(s.cat).c+'22;color:'+catOf(s.cat).c+'">'+catOf(s.cat).ic+' '+(s.ds||"").slice(0,8)+'</div>'});
if(dayRpe.length){var avg=0;dayRpe.forEach(function(r){avg+=r.v});avg=Math.round(avg/dayRpe.length);var rc=avg>=8?"#FF4757":avg>=6?"#F59E0B":"#00E5A0";h+='<div class="cal-ev cal-actual" style="background:'+rc+'22;color:'+rc+';border-left-color:'+rc+'">ğŸ˜“ '+avg+'</div>'}}
h+='</div>'}
h+='</div></div>';
// Weekly plan editor
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ—“</em><h2>é€±é–“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2></div></div>';
plan.forEach(function(d,i){var id=d._id||DKS[i];var zc={UT1:"#3B82F6",AT:"#F59E0B",VO2:"#EF4444",Race:"#00E5A0",OFF:"#475569"}[d.z]||"#475569";
var isMob=window.innerWidth<=640;
if(isMob){h+='<div style="display:grid;grid-template-columns:32px 4px 1fr 40px;gap:6px;align-items:center;padding:10px 8px;border-radius:6px;margin-bottom:3px;cursor:pointer;background:'+(d.z==="OFF"?"transparent":"#0d1422")+';opacity:'+(d.z==="OFF"?.5:1)+'" onclick="openPF(\''+id+'\','+i+')"><span style="font-size:13px;font-weight:800">'+esc(d.dy)+'</span><div style="width:4px;height:24px;border-radius:2px;background:'+zc+'"></div><div><div style="font-size:10px">'+esc(d.am)+'</div><div style="font-size:8px;color:#64748B;margin-top:1px">'+esc(d.pm)+'</div></div>'+zoneBdg(d.z)+'</div>';}
else{h+='<div style="display:grid;grid-template-columns:28px 4px 1fr 1fr 40px;gap:6px;align-items:center;padding:6px 8px;border-radius:5px;margin-bottom:2px;cursor:pointer;background:'+(d.z==="OFF"?"transparent":"#0d1422")+';opacity:'+(d.z==="OFF"?.5:1)+'" onclick="openPF(\''+id+'\','+i+')"><span style="font-size:12px;font-weight:800">'+esc(d.dy)+'</span><div style="width:4px;height:20px;border-radius:2px;background:'+zc+'"></div><div style="font-size:9px">'+esc(d.am)+'</div><div style="font-size:9px;color:#64748B">'+esc(d.pm)+'</div>'+zoneBdg(d.z)+'</div>';}});
h+='</div>';
// Monthly summary
var mSess=sessions.filter(function(s){return s.d&&s.d.slice(0,7)===calYear+"-"+String(calMonth+1).padStart(2,"0")});
var mDur=0,mDist=0;mSess.forEach(function(s){mDur+=(s.dur||0);mDist+=(s.dist||0)});
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“Š</em><h2>æœˆé–“ã‚µãƒãƒªãƒ¼</h2></div></div>';
h+='<div class="g4">'+mC("ä»¶æ•°",mSess.length,"ä»¶","#00E5A0")+mC("æ™‚é–“",mDur,"åˆ†","#0EA5E9")+mC("è·é›¢",(mDist/1000).toFixed(1),"km","#F59E0B")+mC("æ—¥æ•°",Object.keys(mSess.reduce(function(a,s){a[s.d]=1;return a},{})).length,"æ—¥","#8B5CF6")+'</div></div>';
h+='</div>';m.innerHTML=h}

function openDayDetail(ds){var daySess=sessions.filter(function(s){return s.d===ds});var dayRpe=rpe.filter(function(r){return r.d===ds});
var d2=new Date(ds);var dow=(d2.getDay()+6)%7;var planD=plan[dow];
var h='<h3>ğŸ“… '+ds+'</h3>';
// Plan section
if(planD&&planD.z!=="OFF"){var zc={UT1:"#3B82F6",AT:"#F59E0B",VO2:"#EF4444",Race:"#00E5A0"}[planD.z]||"#475569";
h+='<div style="font-size:10px;color:#F59E0B;margin-bottom:4px;font-weight:600">ğŸ“‹ è¨ˆç”»</div>';
h+='<div style="padding:6px 8px;border-radius:4px;background:#F59E0B0A;border-left:3px solid '+zc+';margin-bottom:8px;font-size:9px"><div>AM: '+esc(planD.am)+'</div><div style="color:#64748B">PM: '+esc(planD.pm)+'</div><div style="margin-top:2px">'+zoneBdg(planD.z)+'</div></div>'}
// Actual section
if(daySess.length){h+='<div style="font-size:10px;color:#0EA5E9;margin-bottom:4px;font-weight:600">âœ… å®Ÿç¸¾</div>';
daySess.forEach(function(s){h+='<div style="display:flex;gap:4px;align-items:center;padding:4px 0;font-size:9px">'+catBdg(s.cat)+' '+(s.ds||"")+(s.sp?' <span class="mono" style="color:#00E5A0">'+esc(s.sp)+'</span>':'')+(s.dur?' <span style="color:#64748B">'+s.dur+'åˆ†</span>':'')+'</div>'})}
if(dayRpe.length){h+='<div style="font-size:10px;color:#64748B;margin:8px 0 4px">ğŸ˜“ RPE</div>';
dayRpe.forEach(function(r){var c=r.v>=8?"#FF4757":r.v>=6?"#F59E0B":"#00E5A0";h+='<div style="display:flex;gap:6px;align-items:center;padding:3px 0;font-size:9px"><span style="width:56px">'+esc(r.who)+'</span><span class="mono" style="color:'+c+';font-weight:800">'+r.v+'</span><span style="color:#64748B">'+esc(r.note||"")+'</span></div>'})}
if(!daySess.length&&!dayRpe.length&&(!planD||planD.z==="OFF"))h+='<div class="empty">ã“ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
h+='<div class="modal-btns"><button class="btn btn-p" onclick="closeM();curTab=\'sess\';render();setTimeout(function(){openSF(null)},100)">ï¼‹ è¨˜éŒ²è¿½åŠ </button><button class="btn btn-s" onclick="closeM()">é–‰ã˜ã‚‹</button></div>';openM(h)}

function openPF(id,i){var d=plan[i];var zns=["UT1","UT2","AT","VO2","Race","AN","OFF"];
var h='<h3>ğŸ—“ '+esc(d.dy)+'æ›œæ—¥</h3><div class="fg"><label>AM</label><textarea id="pa">'+esc(d.am)+'</textarea></div><div class="fg"><label>PM</label><textarea id="pp">'+esc(d.pm)+'</textarea></div><div class="fg-row"><div class="fg"><label>ã‚¾ãƒ¼ãƒ³</label><select id="pz">';zns.forEach(function(z){h+='<option value="'+z+'"'+(d.z===z?" selected":"")+'>'+z+'</option>'});
h+='</select></div><div class="fg"><label>è² è·(0-5)</label><input id="pl" type="number" min="0" max="5" value="'+(d.l||0)+'"></div></div><div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="savePF(\''+id+'\','+i+')">ä¿å­˜</button></div>';openM(h)}
function savePF(id,i){var o={dy:plan[i].dy,am:$("pa").value.trim()||"â€”",pm:$("pp").value.trim()||"â€”",z:$("pz").value,l:Math.min(5,Math.max(0,parseInt($("pl").value)||0))};
saveItem("plan",id,o);closeM();if(!isOn)render();toast("è¨ˆç”»æ›´æ–°")}

// ====== ATHLETE (with charts) ======
var selA="";
function drawAthBar(el,sessArr){
  if(!el)return;
  // Last 8 weeks of personal volume
  var weeks=getWeekDates(7);
  var data=weeks.map(function(w){var ws2=new Date(w),we=new Date(w);we.setDate(ws2.getDate()+6);var wes=we.toISOString().slice(0,10);
    var ss=sessArr.filter(function(s){return s.d>=w&&s.d<=wes});var dur=0;ss.forEach(function(s){dur+=(s.dur||0)});return{w:w,dur:dur}});
  var cw=el.clientWidth||320,W=Math.max(cw,280),H=130,ml=30,mr=10,mt=20,mb=26;
  var g=mkS(el,W,H);
  var maxV=Math.max.apply(null,data.map(function(d){return d.dur}))||60;maxV=Math.ceil(maxV/30)*30||60;
  var bw=Math.max(((W-ml-mr)/data.length)-4,8),gap=((W-ml-mr)-bw*data.length)/data.length;
  _s("text",{x:ml,y:12,fill:"#94A3B8","font-size":"8","font-weight":"600"},g).textContent="é€±é–“ç·´ç¿’æ™‚é–“ (åˆ†)";
  for(var i=0;i<=2;i++){var yy=mt+(H-mt-mb)*(1-i/2);_s("line",{x1:ml,y1:yy,x2:W-mr,y2:yy,stroke:"#1E293B","stroke-width":"1"},g);
    _s("text",{x:ml-3,y:yy+3,"text-anchor":"end",fill:"#475569","font-size":"6"},g).textContent=Math.round(maxV*i/2)}
  data.forEach(function(d,i){var x=ml+i*(bw+gap)+gap/2;var bh=Math.max((d.dur/maxV)*(H-mt-mb),1);var y=H-mb-bh;
    _s("rect",{x:x,y:y,width:bw,height:bh,fill:"#8B5CF6",rx:"2",opacity:".75"},g);
    if(d.dur>0)_s("text",{x:x+bw/2,y:y-2,"text-anchor":"middle",fill:"#8B5CF6","font-size":"6","font-weight":"700"},g).textContent=d.dur;
    _s("text",{x:x+bw/2,y:H-mb+10,"text-anchor":"middle",fill:"#64748B","font-size":"6"},g).textContent=d.w.slice(5).replace("-","/")})
}

function rAth(m){var names=crewNames();if(!selA&&names.length)selA=names[0];
var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ‘¤</em><h2>é¸æ‰‹åˆ†æ</h2></div></div><div class="ath-sel">';
names.forEach(function(n){h+='<button class="ath-chip'+(selA===n?" on":"")+'" onclick="selA=\''+esc(n)+'\';render()">'+esc(n)+'</button>'});h+='</div></div>';
var as=sessions.filter(function(s){return s.who===selA||s.who==="å…¨å“¡"});var td2=0,tt=0;as.forEach(function(s){td2+=(s.dist||0);tt+=(s.dur||0)});
var ar=rpe.filter(function(r){return r.who===selA}).sort(function(a,b){return(b.d||"").localeCompare(a.d||"")});
var avgRpe=ar.length?Math.round(ar.slice(0,7).reduce(function(a,r){return a+r.v},0)/Math.min(ar.length,7)*10)/10:0;
var rc=avgRpe>=8?"#FF4757":avgRpe>=6?"#F59E0B":"#00E5A0";
h+='<div class="g4">'+mC("ã‚»ãƒƒã‚·ãƒ§ãƒ³",as.length,"ä»¶","#00E5A0")+mC("æ™‚é–“",tt,"åˆ†","#0EA5E9")+mC("è·é›¢",(td2/1000).toFixed(1),"km","#F59E0B")+mC("RPE(7æ—¥)",avgRpe||"â€”","",rc)+'</div>';
// Charts for athlete
h+='<div class="g2"><div class="cd" style="display:flex;justify-content:center"><div class="chart-wrap" id="aradar" style="max-width:220px"></div></div><div class="cd"><div class="chart-wrap" id="abar"></div></div></div>';
// Recent
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“‹</em><h2>æœ€è¿‘</h2></div></div>';
as.slice(0,10).forEach(function(s,i){h+='<div style="display:flex;gap:4px;padding:4px 6px;border-radius:3px;background:'+(i%2?"transparent":"#0d1422")+';font-size:8px;align-items:center"><span class="mono" style="color:#64748B;width:38px">'+fmtD(s.d)+'</span>'+catBdg(s.cat)+'<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(s.ds||"")+' '+esc(s.nt)+'</span><span class="mono" style="color:#64748B">'+(s.dur?s.dur+'m':'')+'</span></div>'});
if(!as.length)h+='<div class="empty">ãªã—</div>';h+='</div></div>';m.innerHTML=h}

// ====== LIBRARY ======
var LIB_TYPES=[{id:"report",nm:"ãƒ¬ãƒãƒ¼ãƒˆ",ic:"ğŸ“Š",c:"#0EA5E9"},{id:"paper",nm:"è«–æ–‡",ic:"ğŸ“„",c:"#8B5CF6"},{id:"video",nm:"å‹•ç”»",ic:"ğŸ¥",c:"#EF4444"},{id:"doc",nm:"è³‡æ–™",ic:"ğŸ“‹",c:"#F59E0B"},{id:"link",nm:"ãƒªãƒ³ã‚¯",ic:"ğŸ”—",c:"#22C55E"},{id:"other",nm:"ãã®ä»–",ic:"ğŸ“Œ",c:"#64748B"}];
function libTypeOf(id){return LIB_TYPES.find(function(t){return t.id===id})||LIB_TYPES[5]}
var libFilter="ALL";
function rLib(m){
var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“š</em><h2>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2></div><button class="btn btn-p" onclick="openLibF(null)">ï¼‹ è³‡æ–™è¿½åŠ </button></div>';
h+='<div class="sh-s">åˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ»å‚è€ƒæ–‡çŒ®ãƒ»å‹•ç”»ãªã©ã‚’å…±æœ‰</div>';
// Filter
h+='<div class="lib-filter"><button class="btn '+(libFilter==="ALL"?"btn-p":"btn-s")+' btn-sm" onclick="libFilter=\'ALL\';render()">å…¨ã¦</button>';
LIB_TYPES.forEach(function(t){h+='<button class="btn '+(libFilter===t.id?"btn-p":"btn-s")+' btn-sm" onclick="libFilter=\''+t.id+'\';render()">'+t.ic+'</button>'});
h+='</div>';
var fl=library.filter(function(l){return libFilter==="ALL"||l.type===libFilter});
fl.forEach(function(l){var t=libTypeOf(l.type);
h+='<div class="lib-card" onclick="openLibDetail(\''+l._id+'\')">';
h+='<div class="lib-top"><div class="lib-icon" style="background:'+t.c+'18;color:'+t.c+'">'+t.ic+'</div>';
h+='<div class="lib-info"><div class="lib-title">'+esc(l.title)+'</div>';
if(l.desc)h+='<div class="lib-desc">'+esc(l.desc)+'</div>';
h+='</div></div>';
h+='<div class="lib-meta"><span class="lib-tag" style="background:'+t.c+'18;color:'+t.c+'">'+t.nm+'</span>';
if(l.tags){l.tags.split(",").forEach(function(tag){tag=tag.trim();if(tag)h+='<span class="lib-tag">'+esc(tag)+'</span>'})}
h+='<span style="font-size:7px;color:#475569;margin-left:auto">'+esc(l.by||"")+'</span>';
h+='<span style="font-size:7px;color:#475569">'+fmtD(l.d)+'</span></div></div>'});
if(!fl.length)h+='<div class="empty">ã¾ã è³‡æ–™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ãƒãƒ¼ãƒˆã‚„å‚è€ƒæ–‡çŒ®ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ğŸ“š</div>';
h+='</div></div>';m.innerHTML=h}

function openLibF(id){var l=id?library.find(function(x){return x._id===id}):null;
if(!l)l={title:"",type:"report",url:"",desc:"",tags:"",by:"",d:today()};
var h='<h3>ğŸ“š '+(id?"ç·¨é›†":"è¿½åŠ ")+'</h3>';
h+='<div class="fg"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input id="lt" value="'+esc(l.title)+'"></div>';
h+='<div class="fg-row"><div class="fg"><label>ç¨®é¡</label><select id="ltp">';
LIB_TYPES.forEach(function(t){h+='<option value="'+t.id+'"'+(l.type===t.id?" selected":"")+'>'+t.ic+' '+t.nm+'</option>'});
h+='</select></div><div class="fg"><label>æ—¥ä»˜</label><input id="ld" type="date" value="'+l.d+'"></div></div>';
h+='<div class="fg"><label>URL / ãƒªãƒ³ã‚¯</label><input id="lu" value="'+esc(l.url||"")+'" placeholder="https://..."></div>';
h+='<div class="fg"><label>èª¬æ˜</label><textarea id="ldc" rows="3">'+esc(l.desc)+'</textarea></div>';
h+='<div class="fg-row"><div class="fg"><label>ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input id="ltg" value="'+esc(l.tags||"")+'" placeholder="Seiler, æœ‰é…¸ç´ , AT"></div>';
h+='<div class="fg"><label>æŠ•ç¨¿è€…</label><input id="lby" value="'+esc(l.by||"")+'"></div></div>';
h+='<div class="modal-btns">';
if(id)h+='<button class="btn btn-d" onclick="delLib(\''+id+'\')">å‰Šé™¤</button>';
h+='<button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveLibF(\''+(id||"")+"')\">ä¿å­˜</button></div>";openM(h)}

function saveLibF(id){var o={title:$("lt").value.trim()||"ç„¡é¡Œ",type:$("ltp").value,d:$("ld").value||today(),url:$("lu").value.trim(),desc:$("ldc").value.trim(),tags:$("ltg").value.trim(),by:$("lby").value.trim()};
if(!id)id=genId();saveItem("library",id,o);closeM();if(!isOn)render();toast("+5 XP ğŸ“š","xp-toast")}
function delLib(id){if(!confirm("å‰Šé™¤ï¼Ÿ"))return;delItem("library",id);closeM();if(!isOn)render()}

function openLibDetail(id){var l=library.find(function(x){return x._id===id});if(!l)return;var t=libTypeOf(l.type);
var h='<h3>'+t.ic+' '+esc(l.title)+'</h3>';
h+='<div style="display:flex;gap:4px;margin-bottom:8px"><span class="lib-tag" style="background:'+t.c+'18;color:'+t.c+'">'+t.nm+'</span>';
if(l.tags){l.tags.split(",").forEach(function(tag){tag=tag.trim();if(tag)h+='<span class="lib-tag">'+esc(tag)+'</span>'})}h+='</div>';
if(l.desc)h+='<div style="font-size:10px;color:#CBD5E1;margin-bottom:8px;line-height:1.5;white-space:pre-wrap">'+esc(l.desc)+'</div>';
if(l.url)h+='<div style="margin-bottom:8px"><a href="'+esc(l.url)+'" target="_blank" rel="noopener" style="color:#0EA5E9;font-size:10px;word-break:break-all">ğŸ”— '+esc(l.url)+'</a></div>';
h+='<div style="font-size:8px;color:#475569">æŠ•ç¨¿: '+esc(l.by||"â€”")+' | '+esc(l.d)+'</div>';
h+='<div class="modal-btns"><button class="btn btn-s" onclick="closeM();openLibF(\''+id+'\')">âœï¸ ç·¨é›†</button><button class="btn btn-s" onclick="closeM()">é–‰ã˜ã‚‹</button></div>';openM(h)}

// ====== COMMENTS ======
var cmtUser="";
function getCmtUser(){if(cmtUser)return cmtUser;cmtUser=localStorage.getItem("oc_cmt_user")||"";return cmtUser}
function setCmtUser(n){cmtUser=n;localStorage.setItem("oc_cmt_user",n)}
var cmtRole="";
function getCmtRole(){if(cmtRole)return cmtRole;cmtRole=localStorage.getItem("oc_cmt_role")||"athlete";return cmtRole}
function setCmtRole(r){cmtRole=r;localStorage.setItem("oc_cmt_role",r)}

function rCmt(m){
var user=getCmtUser(),role=getCmtRole();
var h='<div class="tab on"><div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ’¬</em><h2>ã‚³ãƒ¡ãƒ³ãƒˆ</h2></div><button class="btn btn-p" onclick="openCmtF(null)">ï¼‹ æŠ•ç¨¿</button></div>';
h+='<div class="sh-s">ç·´ç¿’ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»è³ªå•ã‚’å…±æœ‰</div>';
// User settings bar
h+='<div style="display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap">';
h+='<span style="font-size:8px;color:#64748B">è¡¨ç¤ºå:</span>';
h+='<span style="font-size:9px;font-weight:700;color:#E2E8F0">'+(user||'<span style="color:#FF4757">æœªè¨­å®š</span>')+'</span>';
h+='<span class="cmt-role '+(role==="coach"?"coach":"athlete")+'">'+({coach:"ğŸ“ ã‚³ãƒ¼ãƒ",athlete:"ğŸš£ é¸æ‰‹"}[role]||"ğŸš£ é¸æ‰‹")+'</span>';
h+='<button class="btn btn-s btn-sm" onclick="openCmtSettings()">âš™ï¸ è¨­å®š</button></div>';
// Group by top-level (parentId===null)
var topLevel=comments.filter(function(c){return!c.parentId});
var byParent={};comments.forEach(function(c){if(c.parentId){if(!byParent[c.parentId])byParent[c.parentId]=[];byParent[c.parentId].push(c)}});
topLevel.reverse().forEach(function(c){
h+='<div class="cmt-thread">';
h+=renderCmtCard(c,false);
// Replies
var replies=byParent[c._id]||[];
replies.forEach(function(r){h+=renderCmtCard(r,true)});
h+='</div>'});
if(!topLevel.length)h+='<div class="empty">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç·´ç¿’ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æŠ•ç¨¿ã—ã‚ˆã†ğŸ’¬</div>';
h+='</div></div>';m.innerHTML=h}

function renderCmtCard(c,isReply){
var roleClass=c.role==="coach"?"coach":"athlete";
var roleName=c.role==="coach"?"ğŸ“ ã‚³ãƒ¼ãƒ":"ğŸš£ é¸æ‰‹";
var h='<div class="cmt-card'+(isReply?" reply":"")+'">';
h+='<div class="cmt-head"><span class="cmt-role '+roleClass+'">'+roleName+'</span>';
h+='<span class="cmt-author">'+esc(c.author)+'</span>';
h+='<span class="cmt-date">'+fmtDT(c.ts)+'</span></div>';
// Context tag (linked session)
if(c.sessRef){var s=sessions.find(function(x){return x._id===c.sessRef});
if(s)h+='<div class="cmt-ctx">ğŸ“ '+fmtD(s.d)+' '+catOf(s.cat).ic+' '+(s.ds||"").slice(0,20)+'</div>'}
if(c.topic)h+='<div class="cmt-ctx">ğŸ“‹ '+esc(c.topic)+'</div>';
h+='<div class="cmt-body">'+esc(c.body)+'</div>';
h+='<div class="cmt-actions">';
if(!isReply)h+='<button onclick="openCmtF(\''+c._id+'\')">â†© è¿”ä¿¡</button>';
h+='<button onclick="openCmtEdit(\''+c._id+'\')">âœï¸</button>';
h+='<button onclick="delCmt(\''+c._id+'\')">ğŸ—‘ï¸</button>';
h+='</div></div>';
return h}

function fmtDT(ts){if(!ts)return"";var d=new Date(ts);return(d.getMonth()+1)+"/"+d.getDate()+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")}

function openCmtSettings(){
var user=getCmtUser(),role=getCmtRole();
var h='<h3>âš™ï¸ ã‚³ãƒ¡ãƒ³ãƒˆè¨­å®š</h3>';
h+='<div class="fg"><label>è¡¨ç¤ºå</label><input id="csn" value="'+esc(user)+'" placeholder="åå‰ã‚’å…¥åŠ›"></div>';
h+='<div class="fg"><label>å½¹å‰²</label><select id="csr"><option value="coach"'+(role==="coach"?" selected":"")+'>ğŸ“ ã‚³ãƒ¼ãƒ</option><option value="athlete"'+(role==="athlete"?" selected":"")+'>ğŸš£ é¸æ‰‹</option></select></div>';
h+='<div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveCmtSettings()">ä¿å­˜</button></div>';openM(h)}
function saveCmtSettings(){setCmtUser($("csn").value.trim());setCmtRole($("csr").value);closeM();render();toast("è¨­å®šä¿å­˜")}

function openCmtF(parentId){
var user=getCmtUser(),role=getCmtRole();
if(!user){openCmtSettings();toast("å…ˆã«è¡¨ç¤ºåã‚’è¨­å®šã—ã¦ãã ã•ã„","err");return}
var isReply=!!parentId;
var h='<h3>ğŸ’¬ '+(isReply?"è¿”ä¿¡":"æ–°è¦æŠ•ç¨¿")+'</h3>';
if(!isReply){
// Topic or session link
h+='<div class="fg"><label>ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰</label><input id="cmtp" placeholder="ä¾‹: ã‚­ãƒ£ãƒƒãƒã®æ”¹å–„ã«ã¤ã„ã¦"></div>';
h+='<div class="fg"><label>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç´ä»˜ã‘ï¼ˆä»»æ„ï¼‰</label><select id="cmsr"><option value="">ãªã—</option>';
sessions.slice(0,20).forEach(function(s){h+='<option value="'+s._id+'">'+fmtD(s.d)+' '+catOf(s.cat).ic+' '+(s.ds||"").slice(0,20)+'</option>'});
h+='</select></div>'}
h+='<div class="fg"><label>ã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea id="cmb" rows="4" placeholder="ç·´ç¿’ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚„è³ªå•ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea></div>';
h+='<div class="modal-btns"><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveCmt('+(isReply?"'"+parentId+"'":"null")+')">æŠ•ç¨¿</button></div>';openM(h)}

function saveCmt(parentId){
var body=$("cmb").value.trim();if(!body){toast("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›","err");return}
var o={author:getCmtUser(),role:getCmtRole(),body:body,ts:Date.now(),parentId:parentId||null};
if(!parentId){o.topic=$("cmtp")?$("cmtp").value.trim():"";o.sessRef=$("cmsr")?$("cmsr").value:""}
var id=genId();saveItem("comments",id,o);closeM();if(!isOn)render();toast("+3 XP ğŸ’¬","xp-toast")}

function openCmtEdit(id){var c=comments.find(function(x){return x._id===id});if(!c)return;
var h='<h3>âœï¸ ã‚³ãƒ¡ãƒ³ãƒˆç·¨é›†</h3>';
h+='<div class="fg"><label>ã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea id="cmbe" rows="4">'+esc(c.body)+'</textarea></div>';
h+='<div class="modal-btns"><button class="btn btn-d" onclick="delCmt(\''+id+'\');closeM()">å‰Šé™¤</button><button class="btn btn-s" onclick="closeM()">Ã—</button><button class="btn btn-p" onclick="saveCmtEdit(\''+id+'\')">æ›´æ–°</button></div>';openM(h)}
function saveCmtEdit(id){var c=comments.find(function(x){return x._id===id});if(!c)return;
c.body=$("cmbe").value.trim();c.editedTs=Date.now();
saveItem("comments",id,c);closeM();if(!isOn)render();toast("æ›´æ–°")}
function delCmt(id){if(!confirm("å‰Šé™¤ï¼Ÿ"))return;
// Also delete replies
comments.filter(function(c){return c.parentId===id}).forEach(function(r){delItem("comments",r._id)});
delItem("comments",id);closeM();if(!isOn)render()}

// ====== DATA ======
function rData(m){var h='<div class="tab on"><div class="g4">'+mC("é¸æ‰‹",crew.length,"å","#00E5A0")+mC("è¨˜éŒ²",sessions.length,"ä»¶","#0EA5E9")+mC("è³‡æ–™",library.length,"ä»¶","#3B82F6")+mC("ã‚³ãƒ¡ãƒ³ãƒˆ",comments.length,"ä»¶","#F59E0B")+'</div><div class="g4">'+mC("RPE",rpe.length,"ä»¶","#EF4444")+mC("XP",calcXP(),"pt","#8B5CF6")+mC("","",""," transparent")+mC("","",""," transparent")+'</div>';
h+='<div class="cd"><div class="sh"><div class="sh-l"><em>ğŸ“¤</em><h2>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2></div></div><div class="btns"><button class="btn btn-p" onclick="expJ()">JSON</button><button class="btn btn-s" onclick="expC()">CSV</button></div></div>';
if(isOn){h+='<div class="cd" style="text-align:center;padding:16px"><div style="font-size:9px;color:#64748B;margin-bottom:4px">ãƒãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</div><div style="font-size:28px;font-weight:800;letter-spacing:6px;color:#00E5A0;font-family:monospace">'+tc+'</div><div style="font-size:8px;color:#475569;margin-top:4px">ãƒ¡ãƒ³ãƒãƒ¼ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰</div></div>'}
h+='<div class="cd" style="border-color:#FF475733"><button class="btn btn-d" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div></div>';m.innerHTML=h}
function dl(n,c,t){var b=new Blob([c],{type:t});var a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=n;a.click()}
function expJ(){dl("oarcraft.json",JSON.stringify({crew:crew,sessions:sessions,plan:plan,rpe:rpe,library:library,comments:comments,v:"0.9"},null,2),"application/json");toast("ä¿å­˜")}
function expC(){var r=["æ—¥ä»˜,ã‚«ãƒ†ã‚´ãƒª,ã‚¾ãƒ¼ãƒ³,å¯¾è±¡,å†…å®¹,Split,Rate,HR,è·é›¢,æ™‚é–“,ãƒ¡ãƒ¢"];sessions.forEach(function(s){r.push([s.d,s.cat,s.zone,s.who,s.ds,s.sp,s.r,s.hr||0,s.dist||0,s.dur||0,'"'+(s.nt||"").replace(/"/g,'""')+'"'].join(","))});dl("oarcraft.csv","\uFEFF"+r.join("\n"),"text/csv;charset=utf-8")}
function logout(){if(!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼Ÿ"))return;localStorage.removeItem("oc_tc");location.reload()}
</script>
</body>
</html>
